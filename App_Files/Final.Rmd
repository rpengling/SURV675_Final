---
title: "Final"
output: html_document
---

Now you will have to develop a Shiny app that explores that data and that creates dynamic
reports. The submission will once again be a GitHub repo.

In the Shiny app we will be using the same data as last time but in a different way. Your app will have three
sections:

  1. Overview where you describe the aims of the app and how to navigate it.
  2. Exploration where you will do a graph to describe: the outcome variable, and the three controls:
    age, education and sex.
  3. Regression where you will have a table showing the regression coefficients and a scatter plot showing
    the predicted versus the residuals from the regression. By default the regression has just one outcome
    (whichever you choose as the default) and one predictor, age.
        You will also have four inputs:
          a. Country: here the can select what country all the tables and figures will refer to. The default should
            be the entire sample (I called it “overall”).
          b. Outcome: here the user can select the two outcomes we used in the previous assignment as well: if
            the child suffers when the mother works and if the job should be given to a national. The selection of
            this button will influence the first graph in the “Exploration” section as well as the table and graph
            from “Regression”
          c. Controls: This will be a multiple choice input where the user can select sex and education. If these
            are selected they should be included in the regression model
          d. Age polynomial: This is a numeric input. The default and minimum are 1 and the maximum 5.
            Increasing the number should include multiple polynomials of age in the regression (e.g., selecting 3
            -> “age + ageˆ2 + ageˆ3” should be in the regression)

In addition these inputs you should include a button that creates a html report that includes the information
(text, figures and tables) from Shiny. This should also be dynamic and take as parameters the inputs in
Shiny.

Grading:
• Overview section (10%)
• Exploration section (20%)
• Regression section (30%)
• Dynamic report (20%)
• Repo presentation (10%)
• Publish Shiny app (10%) (include the link to the app in the readme file)

Top tips
• To include a polynomial in a regression a useful command is: “poly()”. For example “poly(age, 4)”
would include 4 polynomials of age
• to create the regression you can treat the formula as a string and you can concatenate things depending
on the inputs chosen by the user
• a easy way to extract the coefficients from a regression is the tidy() command from the broom package.
This creates a table that you can display in Shiny.
• for creating dynamic reports a nice little example can be found here: https://shiny.rstudio.com/
articles/generating-reports.html
• for the dynamic report you want to recreate the sections and outputs from shiny in markdown. You
can give inputs from Shiny as parameters for the report. Look at assignment 2 for some inspiration
• It is easy to publish a shiny app from rstudio. After you run the app just press the “publish” button.
You will need to make an account on: https://www.shinyapps.io/
• If is fine it the dynamic creating of the report works on your computer but not on the shinyapps.io (it
can be tricky to set-up on the server).




```{r}
library(tidyverse)
```

```{r}
Dat <- read_csv("C:\\Users\\Owner\\SURV675_Final\\App_Files\\www\\CleanData.csv")
```


# create graph for overall relationship, need "select all" option for country

```{r}
Dat <- Dat %>%
  mutate(across(c(Sex, Edu, Country), as.factor))

Dat$Age_Group <- cut(Dat$Age, 
                     breaks = c(17, 34, 49, 64, 82), 
                     labels = c("Young Adult", "Middle Adult", "Elder Adult", "Senior Adult"), 
                     right = TRUE)
table(Dat$Age_Group)

Dat <- Dat %>% 
  group_by(Age_Group) %>%
  mutate(
    Ave_GenRol_Age = round(mean(GenRol, na.rm = T), 2),
    Ave_Immig_Age = round(mean(Immig, na.rm = T), 2)
  ) %>% 
  ungroup() %>% 
  group_by(Sex) %>%
  mutate(
    Ave_GenRol_Sex = round(mean(GenRol, na.rm = T), 2),
    Ave_Immig_Sex = round(mean(Immig, na.rm = T), 2)
  ) %>% 
  ungroup() %>% 
  group_by(Edu) %>%
  mutate(
    Ave_GenRol_Edu = round(mean(GenRol, na.rm = T), 2), 
    Ave_Immig_Edu = round(mean(Immig, na.rm = T), 2)
  ) %>% 
  ungroup()  %>% 
  group_by(Country) %>%
  mutate(
    Ave_GenRol_Country = round(mean(GenRol, na.rm = T), 2), 
    Ave_Immig_Country = round(mean(Immig, na.rm = T), 2)
  ) %>% 
  ungroup() 
```

```{r}
Dat1 <- Dat

AllGen_long <- Dat1 %>%
  select(Age_Group, Sex, Edu, 
         Ave_GenRol_Age, Ave_GenRol_Sex, 
         Ave_GenRol_Edu) %>%
  distinct() %>%
  pivot_longer(cols = starts_with("Ave_GenRol"), 
               names_to = "Variable", 
               values_to = "Average") %>%
  mutate(
    Group = case_when(
      Variable == "Ave_GenRol_Age" ~ as.character(Age_Group),
      Variable == "Ave_GenRol_Sex" ~ as.character(Sex),
      Variable == "Ave_GenRol_Edu" ~ as.character(Edu)
    ),
    Variable = recode(Variable,
                      "Ave_GenRol_Age" = "Age_Group",
                      "Ave_GenRol_Sex" = "Sex",
                      "Ave_GenRol_Edu" = "Edu")
  ) 
AllExpGenDat <- AllGen_long %>% 
  select(Variable, Average, Group) %>% unique()
```

```{r}
AllImmig_long <- Dat1 %>%
  select(Age_Group, Sex, Edu, 
         Ave_Immig_Age, Ave_Immig_Sex, 
         Ave_Immig_Edu) %>%
  distinct() %>%
  pivot_longer(cols = starts_with("Ave_Immig"), 
               names_to = "Variable", 
               values_to = "Average") %>%
  mutate(
    Group = case_when(
      Variable == "Ave_Immig_Age" ~ as.character(Age_Group),
      Variable == "Ave_Immig_Sex" ~ as.character(Sex),
      Variable == "Ave_Immig_Edu" ~ as.character(Edu)
    ),
    Variable = recode(Variable,
                      "Ave_Immig_Age" = "Age_Group",
                      "Ave_Immig_Sex" = "Sex",
                      "Ave_Immig_Edu" = "Edu")
  ) 
AllExpImmigDat <- AllImmig_long %>% 
  select(Variable, Average, Group) %>% unique()
```




```{r}

```
























